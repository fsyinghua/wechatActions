name: Test WeChat Notification

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-wechat-notification:
    runs-on: ubuntu-latest
    name: Test WeChat Notification
    steps:
      - name: 检出代码
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install requests>=2.31.0

      - name: 检查密钥
        id: check-secrets
        run: |
          echo "=== 检查密钥 ==="
          
          # 初始化变量
          WEBHOOK_URL=""
          SECRET_NAME=""
          
          # 检查WECHAT_WEBHOOK_URL
          if [ "${{ secrets.WECHAT_WEBHOOK_URL }}" != "" ]; then
              WEBHOOK_URL="${{ secrets.WECHAT_WEBHOOK_URL }}"
              SECRET_NAME="WECHAT_WEBHOOK_URL"
              echo "✅ WECHAT_WEBHOOK_URL 存在"
          fi
          
          # 检查WCOM_WEBHOOK_URL
          if [ -z "$WEBHOOK_URL" ] && [ "${{ secrets.WCOM_WEBHOOK_URL }}" != "" ]; then
              WEBHOOK_URL="${{ secrets.WCOM_WEBHOOK_URL }}"
              SECRET_NAME="WCOM_WEBHOOK_URL"
              echo "✅ WCOM_WEBHOOK_URL 存在"
          fi
          
          # 输出结果
          if [ -n "$WEBHOOK_URL" ]; then
              echo "webhook_url=$WEBHOOK_URL" >> $GITHUB_OUTPUT
              echo "secret_name=$SECRET_NAME" >> $GITHUB_OUTPUT
              echo "secret_exists=true" >> $GITHUB_OUTPUT
          else
              echo "❌ 未找到有效的Webhook URL"
              echo "secret_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: 发送测试消息
        if: steps.check-secrets.outputs.secret_exists == 'true'
        env:
          WEBHOOK_URL: ${{ steps.check-secrets.outputs.webhook_url }}
        run: |
          echo "=== 发送测试消息 ==="
          
          # 创建并运行测试脚本
          cat > test_script.py << 'EOF'
import os
import requests
import json

webhook_url = os.getenv('WEBHOOK_URL')

print(f"使用Webhook URL: {webhook_url[:50]}...")

# 发送测试消息
test_message = {
    'msgtype': 'text',
    'text': {
        'content': '这是来自GitHub Actions的测试消息 ✅\n\n**测试时间**: $(date)\n**测试环境**: GitHub Actions\n**消息类型**: 文本消息'
    }
}

response = requests.post(webhook_url, json=test_message, timeout=10)
response.raise_for_status()

print(f"响应结果: {json.dumps(response.json())}")
print("✅ 测试消息发送成功！")
EOF
          
          python test_script.py

      - name: 总结结果
        run: |
          echo "=== 测试结果 ==="
          if [ "${{ steps.check-secrets.outputs.secret_exists }}" == "true" ]; then
              echo "✅ 测试成功！"
              echo "✅ 使用的密钥: ${{ steps.check-secrets.outputs.secret_name }}"
          else
              echo "❌ 测试失败！"
              echo "❌ 未找到有效的Webhook URL"
              exit 1
          fi
