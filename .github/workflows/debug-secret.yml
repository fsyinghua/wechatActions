name: Debug Secret Configuration

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  debug-secret:
    runs-on: ubuntu-latest
    name: Debug GitHub Secret Configuration
    steps:
      # 步骤1：检出代码
      - name: 检出代码
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
      
      # 步骤2：调试环境变量和Secrets
      - name: 调试环境变量
        run: |
          echo "=== 调试环境变量 ==="
          echo "GITHUB_REPOSITORY: $GITHUB_REPOSITORY"
          echo "GITHUB_EVENT_NAME: $GITHUB_EVENT_NAME"
          echo "GITHUB_ACTOR: $GITHUB_ACTOR"
          echo "=== 调试Secrets ==="
          echo "WECHAT_WEBHOOK_URL (first 50 chars): ${WECHAT_WEBHOOK_URL:0:50}..."
          echo "WECHAT_WEBHOOK_URL exists: ${{ secrets.WECHAT_WEBHOOK_URL != '' }}"
          echo "WECHAT_WEBHOOK_URL length: ${#WECHAT_WEBHOOK_URL}"
        env:
          WECHAT_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK_URL }}
      
      # 步骤3：直接使用Secret调用通知脚本
      - name: 直接使用Secret调用通知脚本
        env:
          INPUT_WECHAT_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK_URL }}
          INPUT_EVENT_TYPES: push
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          echo "=== 直接调用通知脚本 ==="
          python -c "
import os
import sys

print('环境变量检查:')
print(f'INPUT_WECHAT_WEBHOOK_URL exists: {os.environ.get("INPUT_WECHAT_WEBHOOK_URL", "") != ""}')
print(f'INPUT_WECHAT_WEBHOOK_URL: {os.environ.get("INPUT_WECHAT_WEBHOOK_URL", "")[:50]}...')

# 如果webhook URL存在，尝试发送测试通知
webhook_url = os.environ.get('INPUT_WECHAT_WEBHOOK_URL')
if webhook_url:
    print('\n准备发送测试通知...')
    try:
        import requests
        import json
        
        # 发送一个简单的文本消息
        test_message = {
            'msgtype': 'text',
            'text': {
                'content': '这是来自GitHub Actions调试的测试消息'
            }
        }
        
        response = requests.post(webhook_url, json=test_message, timeout=10)
        print(f'HTTP状态码: {response.status_code}')
        print(f'响应内容: {response.text}')
        print('测试完成！')
    except Exception as e:
        print(f'测试失败: {e}')
        import traceback
        traceback.print_exc()
else:
    print('\n跳过测试：WECHAT_WEBHOOK_URL未设置')
"
      
      # 步骤4：使用当前仓库的Action，显式传递Secret
      - name: 使用当前仓库的Action
        uses: ./
        with:
          wechat_webhook_url: ${{ secrets.WECHAT_WEBHOOK_URL }}
          event_types: push