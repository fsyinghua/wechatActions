name: Debug Secret Configuration

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  debug-secret:
    runs-on: ubuntu-latest
    name: Debug GitHub Secret Configuration
    steps:
      # 步骤1：检出代码
      - name: 检出代码
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
      
      # 步骤2：直接检查Secret是否存在（同时支持WECHAT_WEBHOOK_URL和WCOM_WEBHOOK_URL）
      - name: 检查Webhook Secret
        id: check-secret
        run: |
          echo "=== 检查Webhook Secret ==="
          
          # 初始化变量
          WEBHOOK_URL=""
          SECRET_NAME=""
          
          # 检查WECHAT_WEBHOOK_URL Secret
          echo "1. 检查WECHAT_WEBHOOK_URL Secret..."
          if [ "${{ secrets.WECHAT_WEBHOOK_URL }}" != "" ]; then
              WEBHOOK_URL="${{ secrets.WECHAT_WEBHOOK_URL }}"
              SECRET_NAME="WECHAT_WEBHOOK_URL"
              echo "   ✅ WECHAT_WEBHOOK_URL Secret 已存在"
              echo "   ✅ Secret长度: ${{ length(secrets.WECHAT_WEBHOOK_URL) }} 字符"
              echo "   ✅ Secret前30字符: ${{ substring(secrets.WECHAT_WEBHOOK_URL, 0, 30) }}..."
              echo "secret_exists=true" >> $GITHUB_OUTPUT
          else
              echo "   ⚠️ WECHAT_WEBHOOK_URL Secret 不存在或为空"
          fi
          
          # 如果WECHAT_WEBHOOK_URL为空，检查WCOM_WEBHOOK_URL Secret（兼容旧命名）
          if [ -z "$WEBHOOK_URL" ]; then
              echo "2. 检查WCOM_WEBHOOK_URL Secret..."
              if [ "${{ secrets.WCOM_WEBHOOK_URL }}" != "" ]; then
                  WEBHOOK_URL="${{ secrets.WCOM_WEBHOOK_URL }}"
                  SECRET_NAME="WCOM_WEBHOOK_URL"
                  echo "   ✅ WCOM_WEBHOOK_URL Secret 已存在（兼容旧命名）"
                  echo "   ✅ Secret长度: ${{ length(secrets.WCOM_WEBHOOK_URL) }} 字符"
                  echo "   ✅ Secret前30字符: ${{ substring(secrets.WCOM_WEBHOOK_URL, 0, 30) }}..."
                  echo "secret_exists=true" >> $GITHUB_OUTPUT
              else
                  echo "   ⚠️ WCOM_WEBHOOK_URL Secret 不存在或为空"
                  echo "secret_exists=false" >> $GITHUB_OUTPUT
              fi
          fi
          
          # 输出最终结果
          if [ -n "$WEBHOOK_URL" ]; then
              echo "✅ 最终选择的Secret: $SECRET_NAME"
              echo "webhook_url=$WEBHOOK_URL" >> $GITHUB_OUTPUT
          fi
      
      # 步骤3：设置环境变量并测试访问
      - name: 测试环境变量访问
        env:
          WECHAT_WEBHOOK_URL: ${{ steps.check-secret.outputs.webhook_url || secrets.WECHAT_WEBHOOK_URL || secrets.WCOM_WEBHOOK_URL }}
        run: |
          echo "=== 测试环境变量访问 ==="
          echo "环境变量值是否存在: ${{ env.WECHAT_WEBHOOK_URL != '' }}"
          echo "环境变量长度: ${#WECHAT_WEBHOOK_URL}"
          if [ -n "$WECHAT_WEBHOOK_URL" ]; then
              echo "环境变量值前30字符: ${WECHAT_WEBHOOK_URL:0:30}..."
          fi
      
      # 步骤4：使用Python脚本测试密钥访问
      - name: 使用Python脚本测试密钥访问
        env:
          INPUT_WECHAT_WEBHOOK_URL: ${{ steps.check-secret.outputs.webhook_url || secrets.WECHAT_WEBHOOK_URL || secrets.WCOM_WEBHOOK_URL }}
        run: |
          echo "=== 使用Python脚本测试密钥访问 ==="
          python3 test_secret_access.py
      
      # 步骤5：仅当Secret存在时发送测试消息
      - name: 发送测试消息
        if: steps.check-secret.outputs.secret_exists == 'true'
        env:
          WECHAT_WEBHOOK_URL: ${{ steps.check-secret.outputs.webhook_url }}
        run: |
          echo "=== 发送测试消息 ==="
          python3 -c "
import requests
import json

webhook_url = '$WECHAT_WEBHOOK_URL'
print(f'使用Webhook URL: {webhook_url[:50]}...')

# 发送简单的文本消息
test_message = {
    'msgtype': 'text',
    'text': {
        'content': '这是来自GitHub Actions调试的测试消息 ✅'
    }
}

try:
    response = requests.post(webhook_url, json=test_message, timeout=10)
    print(f'HTTP状态码: {response.status_code}')
    print(f'响应内容: {response.text}')
    print('✅ 测试消息发送完成！')
except Exception as e:
    print(f'❌ 测试消息发送失败: {e}')
import traceback
traceback.print_exc()
"