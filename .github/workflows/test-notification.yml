# 测试：GitHub企业微信通知Action
name: 测试企业微信通知

# 监听的事件
on:
  push:
    branches: [ main, master ]

# 任务配置
jobs:
  notify-wechat:
    runs-on: ubuntu-latest
    name: 发送企业微信通知
    steps:
      # 步骤1：检出当前仓库的代码
      - name: 检出代码
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
      
      # 步骤2：设置Python环境
      - name: 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      # 步骤3：安装依赖
      - name: 安装依赖
        run: pip install -r requirements.txt
      
      # 步骤4：运行测试脚本，验证基本功能
      - name: 运行基本测试
        run: python test_main.py
      
      # 步骤5：使用我们的企业微信通知脚本，直接测试发送功能
      # 注意：这里使用环境变量传递Webhook URL，而不是secrets
      # 因为我们需要在这个测试中直接验证功能
      - name: 测试发送到企业微信
        env:
          WECHAT_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK_URL }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: python -c "
import os
import sys
import json

# 添加当前目录到Python路径
sys.path.insert(0, os.getcwd())

# 导入我们的通知模块
from main import main

# 设置必要的环境变量
os.environ['INPUT_WECHAT_WEBHOOK_URL'] = os.environ.get('WECHAT_WEBHOOK_URL')
os.environ['INPUT_EVENT_TYPES'] = 'push,pull_request,issues,release'

# 运行主函数
main()
"
      
      # 步骤6：输出测试结果
      - name: 输出测试结果
        run: echo "测试完成！如果一切正常，您应该已经收到了企业微信通知。"